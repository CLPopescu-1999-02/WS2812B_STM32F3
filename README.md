# ws2812b_stm32F3
This is a fast implementation WS2812B library for STM32 processors.

The example is implemented for STM32F3 line with TIM2. It is possible to change the code to work based on other timer or STM F1, F2 or F4 line. This version is using STM HAL library.

The library is in the /src/ws2812b directory and example of init, redraw and effects are in src/visEffect.c file.

WS2812B has specific communication protocol and it is necessary to bend some standard peripherals to use this protocol. The most easy approach would be implement blocking cycle-exact code in assembly that will spit out ones and zeroes as we need. This is implemented in NeoPixel library for AVR and ARM processor.

Some improvements can be made if part of the bits are generated by some HW peripheral for example SPI or PWM. The best solution is to keep the CPU free and let the DMA and timer do the precise timing. So I've made some DMA tests and it appeared that I can use my code to precise generate necessary waveforms. The I looked around and discovered that this is the approach that already OctoWS2811 library is using. So at least I wasn't completely wrong. But I would like to have better lib.

The octo lib is great when you use lot of parallel strips. Because it can output data for all your 16 strips. On the other side if you use only 2 or 4 LED strips (outputs) then you are wasting your RAM because of the data organization in the library.

Based on your longest LED strip the library creates an array uint16_r buffer[NUMBER_OF_LEDS Ã— 24]. So if you use one strip with ten LEDs then it creates the uint16_t array of length 240 (480 bytes) where only one bit of each item in array is used. So you are wasting 93% of your array in RAM. If you have LED strip connected to the pin PB3 then the 3rd bit of each item in array is used. This is because DMA needs pre-processed data in specific format. I can do better.

My library has more improvements:
#One separate buffer for your (big) framebuffer and second internal bit-buffer for DMA.
RGB framebuffer - this is one dimension array with {R1, G1, B1, R2, G2, B2, ...} format.

Bit-buffer - this is basicaly the same format buffer like the Octo2811 lib uses but it is big only for 2 LEDs (2 LEDs on each of 16 output channels)

*Here is the improvement.* I fill the bit-buffer on-the-fly in the double-buffering fashion based on DMA_HALF_TRANSFER and DMA_COMPLETE_TRANSFER interrupts. 

